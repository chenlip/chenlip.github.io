---
layout: post
title:  "ã€å¼€å‘å­¦ä¹ ã€‘pythonå¼€å‘å­¦ä¹ æ„å»ºè§£æå…¬ç”¨ç±»åŒ…"
date:   2022-03-26 22:27:00
categories: å…¶ä»–
tags:  python, epub, æ–‡ä»¶è§£æ, Xml, Xpath
author: Hoeking
Keywords: epub,xml,xpath
desc: "è¿™æ˜¯ä¸€ä¸ªå­¦ä¹ æ–‡æ¡£"
---

* content
{:toc}


## ä¸€ã€èƒŒæ™¯

å‰ä¸¤å‘¨å·²ç»å°†Pythonçš„è§£æEPUBæ–‡ä»¶å­¦ä¹ ï¼Œæ„Ÿè§‰å·²ç»åŸºæœ¬äº†è§£çš„å…³é”®çš„æŠ€æœ¯ç‚¹ï¼Œå¾ˆå¤šçš„æŠ€æœ¯ç‚¹ä¹Ÿå·²ç»æ”»å…‹ï¼Œä¾‹å¦‚ï¼š
- å¦‚ä½•ä½¿ç”¨æ—¥å¿—
- å¦‚ä½•è§£å‹æ–‡ä»¶ï¼Œå°¤å…¶æ˜¯è§£å‹ï¼ˆå‹ç¼©åŒ…ä¸­çš„ï¼‰å•ä¸ªæ–‡ä»¶
- å¦‚ä½•ä½¿ç”¨xpathæŸ¥è¯¢ï¼Œé’ˆå¯¹æœ‰å‘½åç©ºé—´çš„XMLå’Œæ²¡æœ‰å‘½åç©ºé—´çš„XMLé‡‡ç”¨ä¸åŒæ–¹æ³•
- å¦‚ä½•è°ƒç”¨Haloçš„ç®¡ç†æ¥å£è¿›è¡Œä¿¡æ¯æ›´æ–°ç»´æŠ¤


## äºŒã€æ€è·¯

- å…ˆäº†è§£æ„å»ºä¸€ä¸ªç±»åŒ…çš„ç»“æœåŠæ–‡ä»¶
- åœ¨å¼„æ¸…æ¥šå¦‚ä½•åŒ…è£…å…¬ç”¨çš„åŒ…ç»“æœ
- å…¬ç”¨è§£æç±»è®¾è®¡



## ä¸‰ã€ä»£ç 

### 3.1 æ–‡ä»¶ç»“æ„

![image-20220402205016802](http://minio.sc-model.cn:9000/mdimages/blog/image-20220402205016802_repeat_1648903817682__633022.png)

Vscodeå¼€å‘æ—¶ä¼šç¢°åˆ°è°ƒç”¨è‡ªå·±å¼€å‘çš„  åŒ…å’Œæ¨¡å—  æ‰¾ä¸åˆ°çš„é—®é¢˜ï¼›

[VScode Python no moduleï¼ŒVSCodeå¦‚ä½•è°ƒç”¨è‡ªå·±çš„æ¨¡å—ã€‚_Jacob-xybçš„åšå®¢-CSDNåšå®¢](https://blog.csdn.net/weixin_44560698/article/details/118525324)

![image-20220402205554015](http://minio.sc-model.cn:9000/mdimages/blog/image-20220402205554015_repeat_1648904154371__232705.png)



Vscodeå¼€å‘æ—¶ç”¨F5(è¿è¡Œè°ƒè¯•æ—¶ï¼Œæ²¡æœ‰ä½¿ç”¨pipenvçš„è™šæ‹Ÿç¯å¢ƒï¼Œè€Œæ˜¯ç›´æ¥è°ƒç”¨äº†ç³»ç»Ÿçš„python.exe  )

[â– VSCodeä¸ºPythoné…ç½®Debugè°ƒè¯•(virtualenvç¯å¢ƒ) - ç®€ä¹¦ (jianshu.com)](https://www.jianshu.com/p/ebf445cc7d9f)




### 3.2 å†æ¬¡é‡ç”³æ³¨é‡Šçš„å†™æ³•
- ç±»æ³¨é‡Š
- å±æ€§æ³¨é‡Š
- æ–¹æ³•æ³¨é‡Š
- å¦‚ä½•æ ¹æ®æ³¨é‡Šç”Ÿæˆæ–‡æ¡£

### 3.3 ç±»å±æ€§

```
	# XML å‘½åç©ºé—´ (æ³¨æ„å¤§å°å†™é—®é¢˜)
    NS = {
        'xml': 'http://www.w3.org/XML/1998/namespace',
        'epub': 'http://www.idpf.org/2007/ops',
        'daisy': 'http://www.daisy.org/z3986/2005/ncx/',
        .......
    }
    
    # xpath å…ƒæ•°æ®æŸ¥è¯¢è¯­å¥ï¼Œè¿™é‡Œçš„æŸ¥è¯¢è¯­å¥ä»…ä»…é’ˆå¯¹çš„æ˜¯å­—ç¬¦ä¸²æ ¼å¼çš„æ•°æ®
    OPF_XP_Query = {
        "title" : "//dc:title/text()",
        "author" : "//dc:creator/text()",
		........
    }

    # XML Start
    CONTAINER_PATH = 'META-INF/container.xml'

    IMAGE_MEDIA_TYPES = ['image/jpeg', 'image/jpg', 'image/png', 'image/svg+xml']
```



### 3.4 ç±»åˆå§‹åŒ–

ã€Š__init()ã€‹

```
def __init__(self, epubfn, epuboutpath='/tempepub', epubtemppath='abc'):
        """
        æ„é€ å‡½æ•°, ä¾‹å¦‚ï¼š 
            epub = ParseEpub(f'd:/books/de/X.epub')
            epub.readepub()

        :Args:
            - epubfn: epubæ–‡ä»¶è·¯å¾„ (å¿…é¡»)
            - epuboutpath: epubæ–‡ä»¶å¤„ç†ç»“æœçš„è¾“å‡ºè·¯å¾„ (å¿…é¡»)
            - epubtemppath: epubæ–‡ä»¶å¤„ç†çš„ç¼“å­˜æ–‡ä»¶ (å¯é€‰)
        """
        # epubæ–‡ä»¶è·¯å¾„åŠæ–‡ä»¶å
        self._epubfn = os.fspath(epubfn)
        # epubå¤„ç†çš„ä¸´æ—¶ç›®å½•
        self._tempepubpath = os.path.join(epuboutpath, str(time.time()))
        # opfæ–‡ä»¶å
        self._contentFileName = None
        # ElementTree main object (OPF--XMLå…ƒç´ æ ‘å¯¹è±¡)
        self._xml = None 
        # opfæ–‡ä»¶ ElementTree main object (OPF--XMLå…ƒç´ æ ‘å¯¹è±¡ï¼Œé€‚ç”¨è§£æå¾…åç§°ç©ºé—´çš„æ ‡è®°)
        self._opf_xml = None
        # opfæ–‡ä»¶ ElementTree main object (OPF--HTMLå…ƒç´ æ ‘å¯¹è±¡)
        self._opf_html = None
        # epubä¸­opfæ–‡ä»¶ä¸­çš„å…ƒæ•°æ®èŠ‚ç‚¹
        self._metadataNode = None

        self._ncxFileName = None
        # toc.ncxæ–‡ä»¶ ElementTree main object (toc.ncx--XMLå…ƒç´ æ ‘å¯¹è±¡ï¼Œé€‚ç”¨è§£æå¾…åç§°ç©ºé—´çš„æ ‡è®°)
        self._ncx_xml = None
        # toc.ncxæ–‡ä»¶ ElementTree main object (toc.ncx--HTMLå…ƒç´ æ ‘å¯¹è±¡)
        self._ncx_html = None
        # xml ç‰ˆæœ¬
        self._version = "1.0"
        # epub ç‰ˆæœ¬
        self._epub_version = "2.0"

        # æ—¥å¿—å¤„ç†å¯¹è±¡
        self._logger = None
    #__init__
```

å®é™…ç±»çš„åˆå§‹åŒ–æ“ä½œæ–¹æ³•ï¼šï¼ˆè¿™æ˜¯æœ€æ ¸å¿ƒçš„éƒ¨åˆ†å“¦ï¼‰

```
def readepub(self):
        """
            è®¾ç½®å¯¹è±¡, å¹¶å¯¹å¯¹è±¡è¿›è¡Œåˆå§‹åŒ–æ“ä½œ
        """
        self.setLoger() # è®¾ç½®æ—¥å¿—
        self.exctKeyFile() #è§£å‹ä¸‰ä¸ªå…³é”®XMLæ–‡ä»¶

        try:
            zfile = zipfile.ZipFile(self._epubfn)
            self.findContent(zfile)
        except FileNotFoundError:
            print(f"é”™è¯¯: File '{self._epubfn}' not found. Bailing out.")
            raise FileNotFoundError
        #try

        opffile = os.path.join(self._tempepubpath, self._contentFileName)
        str_opf = open(opffile, 'r', encoding='utf-8').read()

        # å°†'content.opf' æ–‡ä»¶è¯»å–ä½œä¸ºXMLä¸»å¯¹è±¡ï¼Œç”¨äºåç»­ä¿¡æ¯çš„è·å–
        self._xml = ET.fromstring(str_opf.encode("utf-8")) 
        # æ„é€ ä¸€ä¸ªXMLè§£æå™¨ï¼Œç”¨äºå¤„ç†æœ‰åç§°ç©ºé—´ï¼ˆnamespaceï¼‰å®šä¹‰çš„æ ‡è®°
        self._opf_xml = etree.XML(str_opf.encode("utf-8"))
        # æ„é€ ä¸€ä¸ªXMLè§£æå™¨ï¼Œç”¨äºå¤„ç†æœ‰åç§°ç©ºé—´ï¼ˆnamespaceï¼‰å®šä¹‰çš„æ ‡è®°
        self._opf_html = etree.HTML(str_opf.encode("utf-8"))

        self._metadataNode = self._opf_html.xpath("//metadata")
        if self._metadataNode == None:
            raise Exception("æ²¡æœ‰æ‰¾åˆ°OPFå…ƒæ•°æ®çš„XMLæ ‡è®°")
        #

        if 'version' in self._xml.attrib:
            self._version = self._xml.attrib['version']
        #if

        #è·å–ç›®å½•TOCæ–‡ä»¶
        ncxfile = os.path.join(self._tempepubpath,self._ncxFileName)
        str_ncx = open(ncxfile, 'r', encoding='utf-8').read()
        # æ„é€ ä¸€ä¸ªXMLè§£æå™¨ï¼Œç”¨äºå¤„ç†æœ‰åç§°ç©ºé—´ï¼ˆnamespaceï¼‰å®šä¹‰çš„æ ‡è®°
        self._ncx_xml = etree.XML(str_ncx.encode("utf-8"))
        # æ„é€ ä¸€ä¸ªXMLè§£æå™¨ï¼Œç”¨äºå¤„ç†æœ‰åç§°ç©ºé—´ï¼ˆnamespaceï¼‰å®šä¹‰çš„æ ‡è®°
        self._ncx_html = etree.HTML(str_ncx.encode("utf-8"))

        # è®°å½•,epubæ–‡ä»¶å¯¹è±¡åˆå§‹åŒ–å®Œæˆ
        mess_str = f"è§£æ {os.path.basename(self._epubfn)} çš„OPFå’ŒNCXæ–‡ä»¶äº†: {self._contentFileName}; å®Œæˆè§£æepubå¯¹è±¡åˆå§‹åŒ–"
        self._logger.logger.info(mess_str)

    #readepub  
```




### 3.5 ç±»æ–¹æ³•

### 3.6 è§£æç±»çš„è°ƒç”¨æ–¹æ³•

```
import os
from ep.epubparser import ParseEpub

# æµ‹è¯•ä½¿ç”¨epubparseè¿™ä¸ªç±»çš„åŠŸèƒ½æ˜¯å¦æ­£å¸¸
ef_path = "D:\\20_BND\\D_Download\\3-ç”µå­ä¹¦ç±\\0322-03-å½±å“åŠ›ç»å…¸ç‰ˆ.epub"
# æ–‡ä»¶å¤„ç†çš„ä¸´æ—¶ç›®å½•
ef_out_path = "res/mdout/"

ef = ParseEpub(os.fspath(ef_path),epuboutpath=ef_out_path)
ef.readepub()

print(ef.get_metedata("title"))
print(ef.get_metedata("author"))
print(ef.get_metedata("cover"))

print(ef.get_pubdate())
print(ef.get_ISBN())

# å¤„ç†å®Œæˆåæ¸…ç†ä¸´æ—¶æ–‡ä»¶
ef.clear_temp()


```



## å››ã€é—®é¢˜è®°å½•/ç»éªŒç§¯ç´¯

### 4.1 å‹ç¼©æ–‡ä»¶çš„openæ–¹æ³•æ—¶å¾ˆå®¹æ˜“å› ä¸ºä¸­æ–‡å­—ç¬¦é—®é¢˜

æŠ¥é”™ï¼š XMLä¸­fromstring()æ–¹æ³•æŠ¥é”™ï¼šä¸æ­£ç¡®çš„xmlæ ¼å¼æ–‡ä»¶

å¯¹ç­–ï¼šè¿™ä¸ªé—®é¢˜åŸºæœ¬å¾ˆéš¾è§£å†³ï¼Œåªèƒ½ä»æ€è·¯ä¸Šè¿›è¡Œè½¬æ¢ï¼›å…ˆé€šè¿‡zipfileå»ºå…³é”®çš„XMLæ–‡ä»¶å…ˆè§£å‹å‡ºæ¥ï¼Œç„¶åé€šè¿‡è¯»å–xmlæ–‡ä»¶çš„æ–¹å¼å°±å¯ä»¥é¿å…è¿™ä¸ªé—®é¢˜äº†ï¼›

åŸæ¥çš„å†™æ³•ï¼šï¼ˆè€å¤–çš„ä»£ç ï¼Œå› ä¸ºè€å¤–æ²¡æœ‰ä¸­æ–‡å­—ç¬¦çš„é—®é¢˜ï¼Œæ‰€ä»¥è¿™æ ·å†™ï¼‰

```
with zfile.open(self._contentFileName) as file:
     self._xml = ET.fromstring(file.read()) # å°†'content.opf' æ–‡ä»¶è¯»å–ä½œä¸ºXMLä¸»å¯¹è±¡ï¼Œç”¨äºåç»­ä¿¡æ¯çš„è·å–
#with
zfile.close()
```



```
	def exctKeyFile(self):
        """
            å°†ä¸‰ä¸ªé‡è¦æ–‡ä»¶è§£å‹åˆ°ä¸€ä¸ªä¸´æ—¶ç›®å½•ï¼ˆå½“å‰æ—¶é—´æˆ³ï¼‰ä¸­
        """

        if not os.path.exists(self._tempepubpath) : os.mkdir(self._tempepubpath)
        try:
            zfile = zipfile.ZipFile(self._epubfn)
            for f in zfile.namelist():
                if (f.find('container.xml')>0) : zfile.extract(f, self._tempepubpath)
                if (f.find('content.opf')>0) : zfile.extract(f, self._tempepubpath)
                if (f.find('toc.ncx')>0) : 
                    zfile.extract(f, self._tempepubpath)
                    self._ncxFileName = f
        except FileNotFoundError:
            print(f"é”™è¯¯: File '{self._epubfn}' not found. Bailing out.")
            raise FileNotFoundError
        
    #exctKeyFile
    
    .................................
    opffile = os.path.join(self._tempepubpath, self._contentFileName)
    str_opf = open(opffile, 'r', encoding='utf-8').read()

    # å°†'content.opf' æ–‡ä»¶è¯»å–ä½œä¸ºXMLä¸»å¯¹è±¡ï¼Œç”¨äºåç»­ä¿¡æ¯çš„è·å–
    self._xml = ET.fromstring(str_opf.encode("utf-8")) 
    # æ„é€ ä¸€ä¸ªXMLè§£æå™¨ï¼Œç”¨äºå¤„ç†æœ‰åç§°ç©ºé—´ï¼ˆnamespaceï¼‰å®šä¹‰çš„æ ‡è®°
    self._opf_xml = etree.XML(str_opf.encode("utf-8"))
    # æ„é€ ä¸€ä¸ªXMLè§£æå™¨ï¼Œç”¨äºå¤„ç†æœ‰åç§°ç©ºé—´ï¼ˆnamespaceï¼‰å®šä¹‰çš„æ ‡è®°
```



### 4.2 xmlåç§°ç©ºé—´çš„å¤§å°å†™é—®é¢˜å¯¼è‡´xpathæŸ¥è¯¢ä¸åˆ°ç»“æœ

æ ·ä¾‹ä»£ç ï¼š**NS å­—å…¸**ä¸­çš„åç§°ç©ºé—´ ç”¨çš„å¤§å°çš„ â€œDCâ€ï¼› xpathæŸ¥è¯¢è¯­å¥ä¸­ç”¨çš„å°å†™çš„ â€œdcâ€ ï¼›ï¼ˆæµ‹è¯•äº†ï¼Œå¿…é¡»ä¿æŒä¸€è‡´ï¼‰

â€‹		æŠ¥é”™ï¼šlxml.etree.XPathEvalError: Undefined namespace prefix

```
NS = {
    'xml': 'http://www.w3.org/XML/1998/namespace',
    'epub': 'http://www.idpf.org/2007/ops',
    'daisy': 'http://www.daisy.org/z3986/2005/ncx/',
    'opf': 'http://www.idpf.org/2007/opf',
    'containerns': 'urn:oasis:names:tc:opendocument:xmlns:container',
    'DC': 'http://purl.org/dc/elements/1.1/',
    'xhtml': 'http://www.w3.org/1999/xhtml',
    'ncx': 'http://www.daisy.org/z3986/2005/ncx/'
}
............
xpq_str = "//dc:title/text()" 
aid = dom.xpath(xpq_str, namespaces=NS)
```

å¯¹ç­–ï¼šåç§°ç©ºé—´ å¿…é¡»ä¸Xpathä¸­çš„æŸ¥è¯¢ä¸²ä¿æŒä¸€è‡´ï¼ˆ* ä¸xmlæ–‡ä»¶ä¸­çš„xmlnsåˆ°ä¸éœ€è¦ä¿æŒå¤§å°å†™ä¸€è‡´ï¼‰ã€‚

### 4.3 åˆ é™¤æ•´ä¸ªç›®å½•çš„æŠ¥æ²¡æœ‰æƒé™

ä½¿ç”¨import shutilçš„åŒ…ï¼Œç”¨rmtree(path) è§£å†³é—®é¢˜ï¼š

```
	def clear_temp(self):
        """
            æ¸…é™¤å¤„ç†å½“ä¸ªepubæ—¶äº§ç”Ÿçš„ç¼“å­˜æ–‡ä»¶
        """
        f_path = os.path.abspath(self._tempepubpath)
        if (os.path.exists(f_path)):
            #os.remove(f_path)
            shutil.rmtree(f_path)
    #clear_temp
```

### 4.4 å…³äºæ—¥å¿—ä¿å­˜çš„ç›®å½•

ç›®å‰å°†æ—¥å¿—æ–‡ä»¶çš„ä¿å­˜æ”¾åœ¨äº†ä¸€ä¸ªå›ºå®šçš„ç›®å½•ä¸­ï¼Œåç»­è¿˜éœ€è¦å®Œå–„è¯¥åŠŸèƒ½çš„çµæ´»æ€§ã€‚



<img class="img-thumbnail" src="http://minio.sc-model.cn:9000/mdimages/blog/2022/3/28/image-20220328170441666.png" alt="å…»çœ¼ä¼‘æ¯"/>

---

ğŸ¤  <i class="fa-brands fa-weixin"></i> <i class="fa-solid fa-fish-fins"></i> Mobile : 159 6408 0134 ;   E-Mail : chenliping@fangyuanmuban.com.cn

---



